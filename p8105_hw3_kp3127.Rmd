---
title: "p8105_hw3_kp3127"
output: html_document
date: "2025-10-07"
---
```{r setup, echo=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1
```{r}
library(p8105.datasets)
data("instacart")
dim(instacart)
names(instacart)
```
Instacart is an online grocery service that allows you to shop online from local stores. In New York City, partner stores include Whole Foods, Fairway, and The Food Emporium. Instacart offers same-day delivery, and items that users purchase are delivered within 2 hours.  
The Instacart dataset contains `r nrow(instacart)` observations and `r ncol(instacart)` variables.
Each row corresponds to a single product purchased within an order, and variables describe both the product and ordering details.
For instance, key variables include:

`order_id` (unique order identifier)

`product_name` (name of the purchased item)

`aisle and department` (location and product category)

`order_dow` and `order_hour_of_day` (day of week and time of day when order was placed)

Example observations include items such as “Bulgarian Yogurt” from the “yogurt” aisle or “Organic Baby Spinach” from the “fresh vegetables” aisle.
This dataset provides a rich source for exploring consumer purchasing patterns across different times, aisles, and departments.  
```{r}
instacart_sum <- instacart %>% 
  count(aisle_id, aisle, sort = TRUE)
```
There are `r nrow(instacart_sum)` aisles in total. 
The aisle with the most items ordered is `r head(instacart_sum)$aisle[1]`, with `r 
```{r}
instacart_sum %>% 
  filter(n>10000) %>% 
  mutate(aisle = fct_reorder(aisle, n)) 
instacart_sum |>
  ggplot(aes(x = aisle_id, y = n)) +
  geom_point() +
  labs(
    title = "Number of items ordered by aisle (more than 10,000 orders)",
    x = "Aisle_id",
    y = "Number of items ordered"
  ) +
  theme_minimal()
```
```{r}
popular_items = instacart %>%
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) %>%
  group_by(aisle, product_name) %>%
  summarise(n_orders = n()) %>%
  arrange(aisle, desc(n_orders)) %>% 
  filter(min_rank(desc(n_orders))<4)
popular_items
```

```{r}
mean_table <- instacart %>%
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>%
  group_by(product_name, order_dow) %>% 
  summarise(mean_hr=mean(order_hour_of_day, na.rm=TRUE)) %>% 
  mutate(order_dow = recode(order_dow,
                            `0` = "Sun", `1` = "Mon", `2` = "Tue", `3` = "Wed",
                            `4` = "Thu", `5` = "Fri", `6` = "Sat")) %>% 
  pivot_wider(
    names_from = order_dow,
    values_from = mean_hr
  )
mean_table
```

# Problem 2 
```{r}
zip_code=read.csv("./zillow_data/Zip Codes.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    zip=as.character(zip_code)
  ) %>% 
  select(zip,county,neighborhood) %>% 
  arrange(zip)

zori_nyc=read.csv("./zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    cols = 10:last_col(),
    names_to = "date",
    values_to = "rent_index"
  ) %>%
  mutate(
    zip=as.character(region_name),
    date=str_remove(date,"^x"), 
    date=ymd(str_replace_all(date,"_","-"))
  ) %>% 
  select(zip,date,rent_index) %>% 
  drop_na(rent_index) %>%    
  arrange(zip)
```

```{r}
zori_obs <- zori_nyc %>% 
  group_by(zip) %>% 
  summarise(n_obs=n())

n_full <- zori_obs %>%
  filter(n_obs == 116) %>%
  nrow()

n_sparse <- zori_obs %>%
  filter(n_obs < 10) %>%
  nrow()
```
There are `r n_full` ZIP codes observed in all 116 months,
and `r n_sparse` ZIP codes observed fewer than 10 times.  
Why are some ZIP codes are observed rarely and others observed in each month?  
Some ZIP codes appear rarely in the Zillow dataset because Zillow only reports a rent index when there are enough active rental listings to produce a reliable median estimate.

```{r}
zipmap_dups <- zip_code %>% count(zip) %>% filter(n > 1)
zipmap_dups
zip_code <- zip_code %>%
  mutate(
    county = case_when(
      zip == "10463" ~ "Bronx", 
      zip == "11201" ~ "Kings", 
      TRUE ~ county 
    )
  ) %>%
  distinct(zip, .keep_all = TRUE) 
zori_final <- zori_nyc %>%
  left_join(zip_code, by = "zip") %>%
  arrange(zip, date)
```

```{r}
zori_table <- zori_final %>% 
  mutate(year=year(date)) %>% 
  group_by(county,year) %>% 
  summarise(
    mean_rent = mean(rent_index, na.rm = TRUE)
  ) %>% 
  pivot_wider(
    names_from = year,
    values_from = mean_rent
  )
zori_table
```







